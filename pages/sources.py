import streamlit as st
import time
from utils.d1 import delete_source, get_sources
from utils.navigation import make_sidebar
from io import BytesIO

from utils.r2_upload import delete_file_from_r2
from utils.vectorization import pinecone_remove_all, pinecone_remove_source

st.title("Sources")
make_sidebar()

svg_map = {
    "pdf": "https://www.svgrepo.com/show/484113/pdf-file.svg",
    "youtube": "https://www.svgrepo.com/show/13671/youtube.svg",
    "webpage": "https://encrypted-tbn2.gstatic.com/images?q=tbn:ANd9GcT3z6OLss2pupQutUN28SqSx2KvP8Uq-HNWMZly_AxxcuZf6TPk",
    # "webpage": "data:image/png;base64,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",
}

sources = get_sources()

for item in sources:
    col0, col1, col2 = st.columns([1, 9, 1])  # Create two columns for layout
    with col0:
        if item["Type"] == 'youtube':
            try:
                st.image(item["Thumbnail_Url"], use_column_width='auto')
            except:
                st.image(svg_map[item["Type"]], use_column_width='always')
        else:
            st.image(svg_map[item["Type"]], use_column_width='always')  # Display the icon
    with col1:
        with st.expander(item["Name"]):  # Create an expander for each item
            # Display the nested information
            if item['Type'] != 'youtube':
                st.markdown(f"**MD URL:** [{item['MD_file']}]({item['MD_file']})")
            st.markdown(f"**Source URL:** [{item['Source']}]({item['Source']})")
            st.markdown(f"**# of Vectors:** {item['Num_Vectors']}")
    with col2:
        # Create a delete button for each item
        if st.button("üóëÔ∏è", key=item["SourceID"]):  # Delete icon button
            # Remove from D1
            delete_source(item['SourceID'])

            # Remove from R2
            delete_file_from_r2(item['MD_file'].replace('https://r2.contextforce.com/', ''))
            if item['Type'] == 'pdf':
                delete_file_from_r2(item['Source'].replace('https://r2.contextforce.com/', ''))
            
            # Remove from Vectorstore
            pinecone_remove_source(item['Name'])
            st.rerun()

st.markdown("---")
if st.button("Wipeout All Source Vectors"):
    pinecone_remove_all()
